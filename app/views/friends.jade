extends layout
block script
	script(type="text/javascript", src="javascript/ejs_production.js")
	script(type="text/javascript", src="javascript/templates.js")
	script(type="text/javascript", src="javascript/runtime.js")
	script.
		var isEditable = false;
		var ttoleValue = 85;
		function ProfileBS(year, name, branch, attendString, attend, bYear, bMonth, bDay, gender, phone, attendDesc, tension, tensionString, part, photo) {
			
			//- var div = document.createElement("div");
			//- div.innerHTML = html;
			//- document.body.appendChild(div);
			
			var getData = {};
			getData.birthYear = bYear;
			getData.birthMonth = bMonth;
			getData.birthDay = bDay;
			getData.branch = branch;
			getData.name = name;
			getData.attendString = attendString;
			getData.attend = attend;
			getData.gender = gender;
			getData.phone = phone;
			getData.attendDesc = attendDesc;
			getData.tension = tension;
			getData.tensionString = tensionString;
			getData.year = year;
			getData.part = part;
			getData.photo = (photo != 0) ? photo : null;
			//- console.log(getData);
			//- var html = new EJS({url: 'app/views/profile_template.html'}).render(getData);
			var html;
			if (!isEditable)
				html = window.profile_template(getData);
			else
				html = window.profile_edit(getData);
			//- console.log(html);
			document.getElementById("profileData").innerHTML = html;
			
			$(".ui.dropdown").dropdown();
		}
		
		function Display () {
			var $htable = $('table.scrolled'), $table = $('table.scroll'), 
			$bodyCells = $table.find('tbody tr.bMember:last').children(),
			$headCells = $htable.find('thead tr').children(), colWidth = [];
			
			$(window).resize(function() {
				$bodyCells.map(function(i) {
					colWidth[i] = this.clientWidth;
				});
				$headCells.each(function(i, v) {
					$(v).width(colWidth[i]);
				});
			}).resize(); // Trigger resize handler
		}
		
		function addListener(element, eventName, handler) {
			if (element.attachEvent) {
				element.attachEvent('on' + eventName, handler);
			}
			else if (element.addEventListener) {
				element.addEventListener(eventName, handler, false);
			}
			else {
				element['on' + eventName] = handler;
			}
			element['on' + eventName] = handler;
		}

		function removeListener(element, eventName, handler) {
			if (element.detachEvent) {
				element.detachEvent('on' + eventName, handler);
			}
			else if (element.addEventListener) {
				element.removeEventListener(eventName, handler, false);
			}
			else {
				element['on' + eventName] = null;
			}
		}
		
		function UploadSubmit () {
			$('#uploadForm').ajaxSubmit({
				error: function(xhr) {
					alert("데이터 갱신에 실패했습니다.");
				},

				success: function(response) {
					alert("저장되었습니다.");
					if (response.field) {
						var field = response.field;
						var id = field['RowKey'];
						var check = document.getElementById(id);
						var first = check.children[0].children[0];
						var gender = check.children[1];
						var phone = check.children[2];
						var birth = check.children[3];
						var branch = check.children[4];
						var part = check.children[5];
						var attend = check.children[6];
						var desc = check.children[7];
						first.onclick = function () {ProfileBS(field['year'], field['RowKey'], field['branch'], field['attendString'], field['attend'],
						 field['birthYear'], field['birthMonth'], field['birthDay'], field['gender'], field['phone'], field['attendDesc'], 
						 field['tension'], field['tensionString'], field['part'], field['photo'] );
						};
						gender.innerHTML = field['gender'];
						phone.innerHTML = field['phone'];
						birth.innerHTML = (field['birthYear']+1900)+"."+field['birthMonth']+"."+field['birthDay'];
						branch.innerHTML = field['branch'];
						part.innerHTML = field['part'];
						attend.innerHTML = field['attendString'];
						desc.innerHTML = field['attendDesc'];
						//- addListener(document.getElementById('check'), 'click', "ProfileBS()");
					}
				}
			});
		}
		
		function ReadURL(input) {
			var url = input.value;
			var ext = url.substring(url.lastIndexOf('.') + 1).toLowerCase();
			if (input.files && input.files[0] && (ext == "gif" || ext == "png" || ext == "jpeg" || ext == "jpg")) {
				var reader = new FileReader();

				reader.onload = function (e) {
					$('#updateImage').attr('src', e.target.result);
				}
				reader.readAsDataURL(input.files[0]);
			}
			else{
				alert("파일을 올리는데 실패하였습니다.");
			}
		}

		window.onload = function () {
			Display();
		}
		
		function SubMenuFriendClicked (index) {
			var date = new Date();
			var year = date.getYear();
			console.log("sub");
			var $table = $('table.scroll tbody tr');
			if (index == 0) {
				$table.show();
				$table.addClass('bMember');
			}
			if (index == 1) {
				$table.hide();
				$table.removeClass('bMember');
				for (i = 26; i < 40; i++) {
					var getTtole = year - i;
					var setValue = '.' + getTtole;
					$(setValue).show();
					$(setValue).addClass('bMember');
				}
			}
			if (index == 2) {
				$table.hide();
				$table.removeClass('bMember');
				for (i = 19; i < 26; i++) {
					var getTtole = year - i;
					var setValue = '.' + getTtole;
					$(setValue).show();
					$(setValue).addClass('bMember');
				}
			}
			if (index == 3) {
				$table.hide();
				$table.removeClass('bMember');
				[-1,0,1].forEach (function (item) {
					var getTtole = parseInt(ttoleValue) + item;
					var setValue = '.' + getTtole;
					$(setValue).show();
					$(setValue).addClass('bMember');
					
				})
			}
			
			setTimeout(function(){
				Display();
			}, 100);
		}
		
		function SubMenuEditClicked (isEdit) {
			console.log("sub");
			if (!isEdit) {
				isEditable = false;
			}
			if (isEdit) {
				isEditable = true;
			}
		}
	
		function AddMemberButton() {
			$('.ui.modal')
				.modal({
					closable 	: false,
					onDeny 		: function () {
						//- window.alert('Wait not yet!');
						PlusAddMember();
						return false;
					},
					onApprove 	: function () {
						var $getAdd = $('#addMember');
						$('#addMember').ajaxSubmit({
							error: function (xhr) {
								alert('등록 실패했습니다.');
							},
							success: function (response) {
								alert('등록 성공했습니다.');
							}
						});
						//- window.alert('Approved!');
					}
				});
			$('.ui.modal')
				.modal('show');
				
		}
			
block header_item03
	a.main.item.active(href="/friends")
		i.child.icon 
		|Friends
block content
	div.ui.secondary.pointing.menu
		div.ui.container
			a.active.sub.item(onclick="SubMenuFriendClicked(0)") 전체 맴버 현황
			a.sub.item(onclick="SubMenuFriendClicked(1)") 청2부 맴버
			a.sub.item(onclick="SubMenuFriendClicked(2)") 청1부 맴버
			a.sub.item(onclick="SubMenuFriendClicked(3)") 또래 친구들
			div.ui.right.small.menu.buttons
				button.ui.blue.item.active(onclick="SubMenuEditClicked(false)") show
				button.ui.blue.item(onclick="SubMenuEditClicked(true)") edit
			div.ui.right.floated.small.primary.labeled.icon.button(onclick="AddMemberButton()")
				i.user.icon 
				|Add Friend	
	div.main.ui.container(onload="Display()")
		div.ui.grid
			div.twelve.wide.streched.column
				div.ui.segment
					h2.ui.header
						|#{year}년도 청년부 맴버 리스트
					div.ui.container
						table.scrolled.ui.line.celled.table(style="width:100%;border-bottom-width: 5px; margin:0")
							thead
								tr
									th.name 이름
									th.gender 성별
									th.phone 전화번호
									th.birth 생년월일
									th.branch 브랜치
									th.part 소속
									th.attend 출석
									th.desc 비고
						div.member(style="width:100%; height:340px; overflow:auto; margin:0")
							table.scroll.ui.celled.structured.striped.table
								tbody
									each member, i in memberList
										tr.bMember(id="#{member.RowKey}" class="#{member.birthYear}")
											td.name: label(onclick="ProfileBS(#{year}, '#{member.RowKey}','#{member.branch}','#{member.attendString}','#{member.attend}','#{member.birthYear}','#{member.birthMonth}','#{member.birthDay}','#{member.gender}','#{member.phone}','#{member.attendDesc}','#{member.tension ? member.tension : 0}','#{member.tensionString ? member.tensionString : 0}','#{member.part ? member.part : 0}', '#{member.photo ? member.photo : 0}')") #{member.RowKey}
											td.gender #{member.gender?member.gender: '모름'}
											td.phone #{member.phone}
											td.birth #{member.birthYear}.#{member.birthMonth}.#{member.birthDay}															
											td.branch #{ member.branch ? member.branch : '없음'}
											td.part #{ member.part ? member.part : '없음'}
											td.attend(style="min-width:40px") #{ member.attendString ? member.attendString  : '없음'}
											td.desc #{ member.attendDesc ? member.attendDesc : ''}
						table.ui.celled.structured.striped.table(style="margin:0;border-up-width: 5px;")
							tfoot
								tr
									th(colspan="9") 
										div.ui.borderless.small.left.floated.pagination.menu
											a.item(href="/members?") <i class="child icon"></i> all
											a.item(href="/members?attendValue=1") <i class="frown icon"></i> bad
											a.item(href="/members?attendValue=2") <i class="meh icon"></i> well
											a.item(href="/members?attendValue=3") <i class="smile icon"></i> good
											a.item(href="/members?attendValue=4") <i class="thumbs outline up icon"></i> perfect
																				
			div#profileData.four.wide.column
				include profile
	block modal_content
		div.ui.modal
			i.close.icon 
			div.header Add Friend 
			div.ui.content
				form#addMember.ui.fluid.form(action="/addCharge" method="post")
					div.eight.fields
						div.field
							label 이름
							input(name="add_name[0]", placeholder="이름", type="text")
						div.field
							label 성별
							input(name="add_chargeName[0]", placeholder="성별", type="text")
						div.field
							label 전화번호
							input(name="add_chargeGroup[0]", placeholder="소속", type="text")
						div.field
							label 출생년도
							input(name="add_chargeYear[0]", placeholder="년도", type="text")
						div.field
							label 출생 월
							input(name="add_chargeYear[0]", placeholder="월", type="text")
						div.field
							label 출생 날짜
							input(name="add_chargeYear[0]", placeholder="일", type="text")
						div.field
							label 성격
							input(name="add_chargeYear[0]", placeholder="성격", type="text")
						div.field
							label 출석빈도
							input(name="add_chargeYear[0]", placeholder="출석빈도", type="text")
			div.actions 
				div.ui.black.deny.button
					i.plus.center.icon
					|등록 맴버 추가
				div.ui.positive.right.labeled.icon.button 등록
					i.checkmark.icon
						